<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Main Dashboard</title>
    <link rel="stylesheet" href="../styles.css?v=3">
    <link rel="icon" type="image/x-icon" href="images/favicon.ico">
    <script>
        // Verify session server-side first (reliable). If the server check
        // returns 401, redirect to login. If the check can't be reached
        // (network error), fall back to the localStorage token for dev.
        (async function () {
            try {
                const res = await fetch('/checksession', { method: 'GET', credentials: 'same-origin' });
                if (res.ok) {
                    // Session is valid — do nothing and allow the page to render.
                    return;
                }
                // Not authenticated — redirect to login
                window.location.href = '/dashboard/login.html';
            } catch (err) {
                // Fetch failed (likely local dev where functions aren't running).
                // Fall back to the client-side token saved by the login form.
                try {
                    const token = localStorage.getItem('token');
                    if (!token) {
                        window.location.href = '/dashboard/login.html';
                    }
                } catch (e) {
                    window.location.href = '/dashboard/login.html';
                }
            }
        })();
    </script>
</head>

<body>

    <header class="topbar" role="banner">
        <img src="/images/LOGOWITHBG2.png" class="brand" id="logo" aria-label="codachrome home">

        <nav role="navigation" aria-label="Main navigation">
            <ul class="nav-list" role="menubar">
                <li role="none"><a href="/" role="menuitem" class="tab-link">Home</a></li>
                <li role="none"><a href="maindash.html" role="menuitem" class="tab-link">Main Dashboard</a></li>
                <li role="none"><a href="sedash.html" role="menuitem" class="tab-link">SpecEye</a></li>
            </ul>
        </nav>
    </header>

    <div id="header">
        <h2>Main Dashboard</h2>
    </div>

    <div id="container">
        <section id="main">
            <div id="panel-system" class="panel active card">
                <div id="status-container">
                    <span id="status-indicator">...checking status...</span>
                </div>

                <script>
                    const statusSlug = 'vast-oil'; // Replace with your actual slug
                    const apiEndpoint = `api.openstatus.dev{statusSlug}`;
                    const statusIndicator = document.getElementById('status-indicator');
                    const statusContainer = document.getElementById('status-container');

                    async function fetchStatus() {
                        try {
                            const response = await fetch(apiEndpoint);
                            if (!response.ok) {
                                throw new Error('Network response was not ok');
                            }
                            const data = await response.json();
                            // The data object will contain a 'status' field (e.g., 'OPERATIONAL', 'DEGRADED', 'INCIDENT')

                            updateStatusUI(data.status);

                        } catch (error) {
                            console.error("Failed to fetch status:", error);
                            updateStatusUI('ERROR');
                        }
                    }

                    function updateStatusUI(status) {
                        let message = "Status Unknown";
                        let color = "#aaa";

                        switch (status) {
                            case 'OPERATIONAL':
                                message = "All Systems Operational";
                                color = "#10B981"; // Emerald green
                                break;
                            case 'DEGRADED':
                                message = "Some Systems Degraded";
                                color = "#F59E0B"; // Amber
                                break;
                            case 'INCIDENT':
                                message = "Major Incident Detected";
                                color = "#EF4444"; // Red
                                break;
                            case 'MAINTENANCE':
                                message = "Under Scheduled Maintenance";
                                color = "#3B82F6"; // Blue
                                break;
                            default:
                                message = "Status check failed";
                        }

                        statusIndicator.textContent = message;
                        statusContainer.style.color = color;
                    }

                    fetchStatus();
                    // Optionally, set an interval to refresh the status periodically
                    // setInterval(fetchStatus, 60000); // Refresh every minute
                </script>

            </div>
        </section>
    </div>
</body>

</html>