<!DOCTYPE html>
<html>
<head>
    <title>Spectrum Eye Dashboard</title>
    <link rel="stylesheet" href="../styles.css?v=3">
    <script>
        // Verify session server-side first (reliable). If the server check
        // returns 401, redirect to login. If the check can't be reached
        // (network error), fall back to the localStorage token for dev.
        (async function () {
            try {
                const res = await fetch('/checksession', { method: 'GET', credentials: 'same-origin' });
                if (res.ok) {
                    // Session is valid — do nothing and allow the page to render.
                    return;
                }
                // Not authenticated — redirect to login
                window.location.href = '/dashboard/login.html';
            } catch (err) {
                // Fetch failed (likely local dev where functions aren't running).
                // Fall back to the client-side token saved by the login form.
                try {
                    const token = localStorage.getItem('token');
                    if (!token) {
                        window.location.href = '/dashboard/login.html';
                    }
                } catch (e) {
                    window.location.href = '/dashboard/login.html';
                }
            }
        })();
    </script>
</head>
<body>

    <header class="topbar" role="banner">
        <a class="brand" href="/">codachrome</a>

        <nav role="navigation" aria-label="Main navigation">
            <ul class="nav-list" role="menubar">
                <li role="none"><a href="/" role="menuitem" class="tab-link">Home</a></li>
            </ul>
        </nav>
    </header>

    <div id="header">
        <h2>Spectrum Eye Dashboard</h2>
        <div id="connection">● Connecting…</div>
    </div>

    <main>
        <div id="container">

            <aside id="sidebar">
                <button onclick="showPanel('system')">System Stats</button>
                <button onclick="showPanel('spectrum')">Spectrum</button>
                <button onclick="showPanel('commands')">Commands</button>
                <button onclick="showPanel('logs')">Logs</button>
            </aside>

            <section id="main">
                <div id="panel-system" class="panel active card">
                    <h3>System Stats</h3>
                    <div>CPU: <span id="cpu"></span></div>
                    <div>RAM: <span id="ram"></span></div>
                    <div>Temp: <span id="temp"></span></div>
                </div>

                <div id="panel-spectrum" class="panel card">
                    <h3>Spectrum</h3>
                    <canvas id="spectrumCanvas" width="600" height="200"></canvas>
                </div>

                <div id="panel-commands" class="panel card">
                    <h3>Command Runner</h3>

                    <!-- Output first for easier reading -->
                    <pre id="cmd-output" style="min-height:140px;background:rgba(0,0,0,0.08);padding:12px;border-radius:8px;color:var(--muted);overflow:auto"></pre>

                    <!-- Mini nav with categorized preset buttons. Edit data-cmd values to change commands. -->
                    <div class="mini-nav" style="margin-top:12px">
                        <div class="mini-section">
                            <div class="mini-title">SDR</div>
                            <div class="section-buttons">
                                <button class="preset-btn" data-cmd="sdr scan --freq 2.4G">Scan</button>
                                <button class="preset-btn" data-cmd="sdr start_rx">Start RX</button>
                            </div>
                        </div>

                        <div class="mini-section">
                            <div class="mini-title">Pentest</div>
                            <div class="section-buttons">
                                <button class="preset-btn" data-cmd="nmap -sC -T4 192.168.1.0/24">Nmap Quick</button>
                                <button class="preset-btn" data-cmd="exploit run target">Run Exploit</button>
                            </div>
                        </div>

                        <div class="mini-section">
                            <div class="mini-title">System</div>
                            <div class="section-buttons">
                                <button class="preset-btn" data-cmd="cat /proc/cpuinfo">Show CPU</button>
                                <button class="preset-btn" data-cmd="sudo reboot">Reboot</button>
                            </div>
                        </div>

                        <div class="mini-section">
                            <div class="mini-title">Server</div>
                            <div class="section-buttons">
                                <button class="preset-btn" data-cmd="systemctl restart myservice">Restart Service</button>
                                <button class="preset-btn" data-cmd="tail -n 200 /var/log/syslog">Tail Logs</button>
                            </div>
                        </div>
                    </div>

                    <!-- Command input area -->
                    <div style="margin-top:12px;display:flex;gap:8px;align-items:center">
                        <input id="cmd" placeholder="Enter command" style="flex:1;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:inherit">
                        <button class="btn" onclick="sendCommand()">Run</button>
                    </div>
                </div>

                <div id="panel-logs" class="panel card">
                    <h3>Logs</h3>
                    <pre id="logs" style="background:rgba(0,0,0,0.12);padding:12px;border-radius:8px;color:var(--muted)"></pre>
                </div>
            </section>

        </div>
    </main>

<script src="dashboard.js"></script>
<script>
// Wire preset buttons: set the input and send the command using existing sendCommand()
document.addEventListener('click', function (e) {
    const btn = e.target.closest && e.target.closest('.preset-btn');
    if (!btn) return;
    const cmd = btn.getAttribute('data-cmd') || btn.textContent || '';
    const input = document.getElementById('cmd');
    if (input) input.value = cmd;
    // give a small visual cue in the output
    const out = document.getElementById('cmd-output');
    if (out) out.textContent = `> ${cmd}\n` + (out.textContent || '');
    // call the existing sendCommand function (defined in dashboard.js)
    if (typeof sendCommand === 'function') sendCommand();
});
</script>
</body>
</html>
