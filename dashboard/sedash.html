<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spectrum Eye Dashboard</title>
    <link rel="stylesheet" href="../styles.css?v=3">
    <script>
        // Verify session server-side first (reliable). If the server check
        // returns 401, redirect to login. If the check can't be reached
        // (network error), fall back to the localStorage token for dev.
        (async function () {
            try {
                const res = await fetch('/checksession', { method: 'GET', credentials: 'same-origin' });
                if (res.ok) {
                    // Session is valid — do nothing and allow the page to render.
                    return;
                }
                // Not authenticated — redirect to login
                window.location.href = '/dashboard/login.html';
            } catch (err) {
                // Fetch failed (likely local dev where functions aren't running).
                // Fall back to the client-side token saved by the login form.
                try {
                    const token = localStorage.getItem('token');
                    if (!token) {
                        window.location.href = '/dashboard/login.html';
                    }
                } catch (e) {
                    window.location.href = '/dashboard/login.html';
                }
            }
        })();
    </script>
</head>

<body>

    <header class="topbar" role="banner">
        <a class="brand" href="/">codachrome</a>

        <nav role="navigation" aria-label="Main navigation">
            <ul class="nav-list" role="menubar">
                <li role="none"><a href="/" role="menuitem" class="tab-link">Home</a></li>
            </ul>
        </nav>
    </header>

    <div id="header">
        <h2>Spectrum Eye Dashboard</h2>
        <div id="connection">● Connecting…</div>
    </div>

    <div id="container">

        <aside id="sidebar">
            <button onclick="showPanel('system')">System Stats</button>
            <!-- <button onclick="showPanel('spectrum')">Spectrum</button> -->
            <button onclick="showPanel('commands')">Commands</button>
            <button onclick="showPanel('logs')">Logs</button>
        </aside>

        <section id="main">
            <div id="panel-system" class="panel active card">
                <h3>System Stats</h3>
                <div>CPU: <span id="cpu"></span></div>
                <div>RAM: <span id="ram"></span></div>
                <div>Temp: <span id="temp"></span></div>
            </div>

            <!-- <div id="panel-spectrum" class="panel card">
                <h3>Spectrum</h3>
                <canvas id="spectrumCanvas" width="600" height="200"></canvas>
            </div> -->

            <div id="panel-commands" class="panel card">
                <h3>Command Runner</h3>

                <!-- Output first for easier reading -->
                <pre id="cmd-output"
                    style="min-height:140px;background:rgba(0,0,0,0.08);padding:12px;border-radius:8px;color:var(--muted);overflow:auto;word-wrap:break-word"></pre>



                <!-- Command input area -->
                <div style="margin-top:12px;display:flex;gap:8px;align-items:center">
                    <input id="cmd" placeholder="Enter command"
                        style="flex:1;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:inherit">
                    <button class="btn" onclick="sendCommand()">Run</button>
                </div>

                <!-- Mini nav with categorized preset buttons -->
                <div class="mini-nav" style="margin-top:12px">
                    <div class="mini-section">
                        <div class="mini-title">SDR</div>
                        <div class="section-buttons">
                            <button class="preset-btn" data-cmd="sdr-scan">sdr-scan</button>
                            <button class="preset-btn" data-cmd="sdr-start-rx">sdr-start-rx</button>
                            <button class="preset-btn" data-cmd="sdr-stop-rx">sdr-stop-rx</button>
                            <button class="preset-btn" data-cmd="sdr-spec">sdr-spec</button>
                        </div>
                    </div>

                    <div class="mini-section">
                        <div class="mini-title">Network</div>
                        <div class="section-buttons">
                            <button class="preset-btn" data-cmd="net-scan">net-scan</button>
                            <button class="preset-btn" data-cmd="net-arp">net-arp</button>
                            <button class="preset-btn" data-cmd="net-ports">net-ports</button>
                            <button class="preset-btn" data-cmd="net-traffic">net-traffic</button>
                            <button class="preset-btn" data-cmd="net-dns">net-dns</button>
                            <button class="preset-btn" data-cmd="net-ping">net-ping</button>
                            <button class="preset-btn" data-cmd="net-trace">net-trace</button>
                        </div>
                    </div>

                    <div class="mini-section">
                        <div class="mini-title">System</div>
                        <div class="section-buttons">
                            <button class="preset-btn" data-cmd="sys-uptime">sys-uptime</button>
                            <button class="preset-btn" data-cmd="sys-disk">sys-disk</button>
                            <button class="preset-btn" data-cmd="sys-mem">sys-mem</button>
                            <button class="preset-btn" data-cmd="sys-proc">sys-proc</button>
                            <button class="preset-btn" data-cmd="sys-temp">sys-temp</button>
                            <button class="preset-btn" data-cmd="sys-ip">sys-ip</button>
                            <button class="preset-btn" data-cmd="sys-gpio">sys-gpio</button>
                        </div>
                    </div>

                    <div class="mini-section">
                        <div class="mini-title">Server</div>
                        <div class="section-buttons">
                            <button class="preset-btn" data-cmd="ws-restart">ws-restart</button>
                            <button class="preset-btn" data-cmd="ws-status">ws-status</button>
                            <button class="preset-btn" data-cmd="logs-ws">logs-ws</button>
                            <button class="preset-btn" data-cmd="tunnel-restart">tunnel-restart</button>
                            <button class="preset-btn" data-cmd="tunnel-status">tunnel-status</button>
                            <button class="preset-btn" data-cmd="logs-tunnel">logs-tunnel</button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="panel-logs" class="panel card">
                <h3>Logs</h3>
                <pre id="logs"
                    style="background:rgba(0,0,0,0.12);padding:12px;border-radius:8px;color:var(--muted)"></pre>
            </div>


        </section>

        <!-- Command Library (reference section) -->
        <section id="library">
            <div style="margin-top:30px; padding:16px; border-radius:12px; background:#111; color:#eee;">
                <h2 style="margin-bottom:12px;">Command Library</h2>
                <p style="margin-top:-6px; opacity:0.75;">Reference guide for all preset commands available in the
                    dashboard.</p>

                <!-- SDR Commands -->
                <div style="margin-top:20px;">
                    <h3>SDR Commands</h3>
                    <ul>
                        <li><strong>sdr-scan</strong> — Sweeps a frequency range and reports detected signals.</li>
                        <li><strong>sdr-start-rx</strong> — Starts SDR receive mode on the Pi.</li>
                        <li><strong>sdr-stop-rx</strong> — Stops the SDR receiver.</li>
                        <li><strong>sdr-spec</strong> — Runs a quick spectrum capture (FFT snapshot).</li>
                    </ul>
                </div>

                <!-- Network / Pentesting Tools (Safe Recon Only) -->
                <div style="margin-top:20px;">
                    <h3>Network Tools</h3>
                    <ul>
                        <li><strong>net-scan</strong> — Fast scan of your local subnet using nmap safe scripts.</li>
                        <li><strong>net-ports</strong> — Lists open TCP/UDP ports on the Pi itself.</li>
                        <li><strong>net-dns</strong> — Shows DNS configuration and resolvers.</li>
                        <li><strong>net-ping</strong> — Pings 8.8.8.8 for latency & connectivity.</li>
                        <li><strong>net-trace</strong> — Runs traceroute to a domain.</li>
                        <li><strong>net-arp</strong> — Shows LAN device table (ARP cache).</li>
                        <li><strong>net-traffic</strong> — Live bandwidth summary via ifstat.</li>
                    </ul>
                </div>

                <!-- System -->
                <div style="margin-top:20px;">
                    <h3>System</h3>
                    <ul>
                        <li><strong>sys-uptime</strong> — Shows how long the Pi has been running.</li>
                        <li><strong>sys-disk</strong> — Displays disk usage (free space, size, mounts).</li>
                        <li><strong>sys-mem</strong> — Memory usage overview.</li>
                        <li><strong>sys-proc</strong> — Top 15 running processes.</li>
                        <li><strong>sys-temp</strong> — Device temperature sensor readout.</li>
                        <li><strong>sys-ip</strong> — All assigned IP addresses.</li>
                        <li><strong>sys-gpio</strong> — Lists GPIO pin state (requires gpiod).</li>
                    </ul>
                </div>

                <!-- Server -->
                <div style="margin-top:20px;">
                    <h3>Server Controls</h3>
                    <ul>
                        <li><strong>ws-restart</strong> — Restart the WebSocket server service.</li>
                        <li><strong>ws-status</strong> — Show WebSocket service status.</li>
                        <li><strong>tunnel-restart</strong> — Restart Cloudflared tunnel.</li>
                        <li><strong>tunnel-status</strong> — Show Cloudflared status/logs.</li>
                        <li><strong>logs-ws</strong> — View recent logs of the WS server.</li>
                        <li><strong>logs-tunnel</strong> — View recent Cloudflared logs.</li>
                    </ul>
                </div>

            </div>
        </section>

    </div>


    <script src="dashboard.js"></script>
    <script>
        // Wire preset buttons ONLY within commands panel to avoid persistence across pages
        const cmdPanel = document.getElementById('panel-commands');
        if (cmdPanel) {
            cmdPanel.addEventListener('click', function (e) {
                const btn = e.target.closest && e.target.closest('.preset-btn');
                if (!btn) return;
                const cmd = btn.getAttribute('data-cmd') || btn.textContent || '';
                const input = document.getElementById('cmd');
                if (input) input.value = cmd;
                const out = document.getElementById('cmd-output');
                if (out) out.textContent = `> ${cmd}\n` + (out.textContent || '');
                if (typeof sendCommand === 'function') sendCommand();
            });
        }
    </script>
</body>

</html>